{{- $termsPage := site.GetPage "/columns" -}}
{{- $currentColumn := "" -}}
{{- if and (eq .Kind "term") (eq .Type "columns") -}}
  {{- $currentColumn = .Data.Term -}}
{{- else if and (eq .Kind "page") (.Params.columns) -}}
  {{- $currentColumn = index .Params.columns 0 -}}
{{- end -}}

<aside class="column-sidebar" aria-label="分栏导航">
  <button class="column-sidebar-toggle" type="button" aria-expanded="true" aria-controls="column-tree">
    隐藏目录
  </button>
  <div class="column-sidebar-body" id="column-tree">
    {{- if $termsPage }}
    <ul class="column-flat-data" hidden>
      {{- range site.Taxonomies.columns.Alphabetical }}
      {{- $name := .Name -}}
      {{- $count := .Count -}}
      {{- with site.GetPage (printf "/columns/%s" $name) }}
      <li data-path="{{ $name }}" data-url="{{ .RelPermalink }}" data-count="{{ $count }}"></li>
      {{- end }}
      {{- end }}
    </ul>
    {{- else }}
    <p class="column-sidebar-empty">暂无分栏，请先在文章 front matter 中设置 <code>columns</code>。</p>
    {{- end }}
    <nav class="column-tree-nav" data-current="{{ $currentColumn }}"></nav>
  </div>
</aside>
<button class="column-sidebar-fab" type="button" aria-expanded="false" aria-label="展开分栏目录">
  目录
</button>

<script>
(() => {
  const shell = document.querySelector('.site-shell');
  const treeNav = document.querySelector('.column-tree-nav');
  const toggleBtn = document.querySelector('.column-sidebar-toggle');
  const fabBtn = document.querySelector('.column-sidebar-fab');
  const storageKey = 'cl_sidebar_hidden';
  if (!shell || !toggleBtn || !fabBtn) return;

  const setSidebarState = (hidden) => {
    shell.classList.toggle('sidebar-hidden', hidden);
    toggleBtn.setAttribute('aria-expanded', String(!hidden));
    fabBtn.setAttribute('aria-expanded', String(!hidden));
    toggleBtn.textContent = hidden ? '显示目录' : '隐藏目录';
    fabBtn.classList.toggle('is-visible', hidden);
    localStorage.setItem(storageKey, hidden ? '1' : '0');
  };

  const initialHidden = localStorage.getItem(storageKey) === '1';
  setSidebarState(initialHidden);
  toggleBtn.addEventListener('click', () => setSidebarState(!shell.classList.contains('sidebar-hidden')));
  fabBtn.addEventListener('click', () => setSidebarState(false));

  if (!treeNav) return;
  const source = document.querySelectorAll('.column-flat-data li');
  if (!source.length) {
    treeNav.innerHTML = '<p class="column-sidebar-empty">暂无分栏</p>';
    return;
  }

  const currentPath = (treeNav.dataset.current || '').trim();
  const nodes = {};
  const root = { children: {} };

  source.forEach((item) => {
    const fullPath = item.dataset.path;
    const url = item.dataset.url;
    const count = Number(item.dataset.count || '0');
    const parts = fullPath.split('/').filter(Boolean);
    let cursor = root;
    let aggregatePath = '';

    parts.forEach((part) => {
      aggregatePath = aggregatePath ? `${aggregatePath}/${part}` : part;
      if (!cursor.children[part]) {
        cursor.children[part] = { label: part, path: aggregatePath, children: {} };
      }
      cursor = cursor.children[part];
    });

    cursor.url = url;
    cursor.count = count;
  });

  const isAncestorOfCurrent = (path) => currentPath && (currentPath === path || currentPath.startsWith(path + '/'));

  const renderNode = (node) => {
    const li = document.createElement('li');
    const hasChildren = Object.keys(node.children).length > 0;
    const openByDefault = isAncestorOfCurrent(node.path);

    if (hasChildren) {
      const details = document.createElement('details');
      details.open = openByDefault;
      const summary = document.createElement('summary');
      if (node.url) {
        const link = document.createElement('a');
        link.href = node.url;
        link.textContent = node.label;
        summary.appendChild(link);
      } else {
        summary.textContent = node.label;
      }
      if (node.count) {
        const sup = document.createElement('sup');
        sup.textContent = ` ${node.count}`;
        summary.appendChild(sup);
      }
      details.appendChild(summary);

      const ul = document.createElement('ul');
      Object.values(node.children)
        .sort((a, b) => a.label.localeCompare(b.label, 'zh-Hans-CN'))
        .forEach((child) => ul.appendChild(renderNode(child)));
      details.appendChild(ul);
      li.appendChild(details);
    } else {
      const link = document.createElement('a');
      link.href = node.url || '#';
      link.textContent = node.label;
      if (node.count) {
        const sup = document.createElement('sup');
        sup.textContent = ` ${node.count}`;
        link.appendChild(sup);
      }
      li.appendChild(link);
    }

    if (node.path === currentPath) {
      li.classList.add('is-current-column');
    }
    return li;
  };

  const rootList = document.createElement('ul');
  rootList.className = 'column-tree-root';
  Object.values(root.children)
    .sort((a, b) => a.label.localeCompare(b.label, 'zh-Hans-CN'))
    .forEach((node) => rootList.appendChild(renderNode(node)));
  treeNav.appendChild(rootList);
})();
</script>
